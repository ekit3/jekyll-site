
<!doctype html>
<html>
    <head>
        <meta name="theme-color" content="#000000"/>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>direnv pour booster votre shell</title>
        <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/assets/css/select2.min.css" />
        <link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Bienvenue sur le Blog d'Ekite" />
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="/css/main.css" />
        <link rel="icon" href="/assets/images/favicon.png" href="logo.png" />
        <link rel="manifest" href="/manifest.webmanifest">
        
            <script
  async
  src="https://www.googletagmanager.com/gtag/js?id=G-D332437KRM"
></script>
<script>

    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    var tagAnalyticsCNIL = {};

    tagAnalyticsCNIL.CookieConsent = (function () {
    var gaProperty = "G-D332437KRM";
    // Désactive le tracking si le cookie d’Opt-out existe déjà.
    var disableStr = `ga-disable-${gaProperty}`;
    var firstCall = false;
    var domaineName = "";

    //Cette fonction retourne la date d’expiration du cookie de consentement

    function getCookieExpireDate() {
        var cookieTimeout = 33696000000; // Le nombre de millisecondes que font 13 mois
        var date = new Date();
        date.setTime(date.getTime() + cookieTimeout);
        var expires = "; expires=" + date.toGMTString();
        return expires;
    }

    function getDomainName() {
        if (domaineName != "") {
            return domaineName;
        } else {
            var hostname = document.location.hostname;
            if (hostname.indexOf("www.") === 0) hostname = hostname.substring(4);
            return hostname;
        }
    }

    //Cette fonction définie le périmétre du consentement ou de l'opposition  (en fonction du domaine)
    //Par défaut nous considérons que le domaine est tout ce qu'il y'a aprés  "www"
    function getCookieDomainName() {
        var hostname = getDomainName();
        var domain = "domain=" + "." + hostname;
        return domain;
    }

    //Cette fonction vérifie si on  a déjà obtenu le consentement de la personne qui visite le site
    function checkFirstVisit() {
        var consentCookie = getCookie("hasConsent");
        if (!consentCookie) return true;
    }

    function showBanner() {
        var bodytag = document.getElementsByTagName("body")[0];
        var div = document.createElement("div");
        div.setAttribute('id','cookie-banner');
        div.style.width = window.innerWidth + "px";
        div.style.height = window.innerHeight + "px";
        div.style.position = "fixed";
        div.style.zIndex = "100000";
        div.style.backgroundColor = "#11111190"
        div.innerHTML = `
                <div style="width: 300px; 1px solid #2F343A; border-radius: 5px; background-color: #f1f1f1; repeat scroll 0% 0% white; padding :10px 10px;text-align:center; position: fixed; top:30px; left:50%; margin-top:0px; margin-left:-150px; z-index:100000; id="inform-and-consent">
                    <div>
                        <span><b>Ce site utilise Google Analytics</b></span><br/><br/>
                        En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure d'audience.
                    </div>
                    <div style="padding :20px;text-align:center;">
                    <button 
                        style="margin-right:50px;"
                        class="btn btn-light"
                        name="Refuser"
                        onclick="tagAnalyticsCNIL.CookieConsent.gaOptout();tagAnalyticsCNIL.CookieConsent.hideInform();"
                        id="optout-button">
                        Refuser
                    </button>
                    <button
                        id="accept-ga"
                        name="Valider"
                        class="btn btn-success"
                        onclick="tagAnalyticsCNIL.CookieConsent.hideInform()">
                        Accepter
                    </button>
                    </div>
                </div>
            `;
      bodytag.insertBefore(div, bodytag.firstChild);
    }

    // Fonction utile pour récupérer un cookie a partire de son nom
    function getCookie(NameOfCookie) {
        if (document.cookie.length > 0) {
            begin = document.cookie.indexOf(NameOfCookie + "=");
            if (begin != -1) {
            begin += NameOfCookie.length + 1;
            end = document.cookie.indexOf(";", begin);
            if (end == -1) end = document.cookie.length;
            return unescape(document.cookie.substring(begin, end));
            }
        }
        return null;
    }

    //Récupère la version d'Internet Explorer, si c'est un autre navigateur la fonction renvoie -1
    function getInternetExplorerVersion() {
        var rv = -1;
        if (navigator.appName == "Microsoft Internet Explorer") {
            var ua = navigator.userAgent;
            var re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) rv = parseFloat(RegExp.$1);
        } else if (navigator.appName == "Netscape") {
            var ua = navigator.userAgent;
            var re = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) rv = parseFloat(RegExp.$1);
        }
        return rv;
    }

    //Effectue une demande de confirmation de DNT pour les utilisateurs d'IE
    function askDNTConfirmation() {
        var r = confirm(
            "La signal DoNotTrack de votre navigateur est activé, confirmez vous activer la fonction DoNotTrack?"
        );
        return r;
    }

    //Vérifie la valeur de navigator.DoNotTrack pour savoir si le signal est activé et est à 1
    function notToTrack() {
        if (
            (navigator.doNotTrack &&
            (navigator.doNotTrack == "yes" || navigator.doNotTrack == "1")) ||
            (navigator.msDoNotTrack && navigator.msDoNotTrack == "1")
        ) {
            var isIE = getInternetExplorerVersion() != -1;
            if (!isIE) {
            return true;
            } else {
            return askDNTConfirmation();
            }
            return false;
        }
    }

    //Si le signal est à 0 on considére que le consentement a déjà été obtenu
    function isToTrack() {
      if (
        navigator.doNotTrack &&
        (navigator.doNotTrack == "no" || navigator.doNotTrack == 0)
      ) {
        return true;
      }
    }

    // Fonction d'effacement des cookies
    function delCookie(name) {
      var path = ";path=" + "/";

      var expiration = "Thu, 01-Jan-1970 00:00:01 GMT";
      document.cookie = `${name}=${path} ; ${getCookieDomainName()} ;expires=${expiration}`;
    }

    // Efface tous les types de cookies utilisés par Google Analytics
    function deleteAnalyticsCookies() {
      var cookieNames = ["__utma", "__utmb", "__utmc", "__utmz", "_ga", "_gat"];
      for (var i = 0; i < cookieNames.length; i++) delCookie(cookieNames[i]);
    }

    function isClickOnOptOut(evt) {
      // Si le noeud parent ou le noeud parent du parent est la banniére, on ignore le clic
      return (
        evt.target.parentNode.id == "cookie-banner" ||
        evt.target.parentNode.parentNode.id == "cookie-banner" ||
        evt.target.id == "optout-button"
      );
    }

    function consent(evt) {
      if (!isClickOnOptOut(evt)) {
        // On vérifie qu'il ne s'agit pas d'un clic sur la banniére
        if (!clickprocessed) {
         evt.preventDefault();
         closeModalAfterClickProcessed();
        }
      }
      if(evt.target.id === 'accept-ga'){
        evt.preventDefault();
          document.cookie = `hasConsent=true ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
          callGoogleAnalytics();
          closeModalAfterClickProcessed();
        }
    }

    function closeModalAfterClickProcessed(){
        clickprocessed = true;
        window.setTimeout(function () {
        evt.target.click();
        }, 1000);
        tagAnalyticsCNIL.CookieConsent.hideInform();
    }

    // Tag Google Analytics, cette version est avec le tag Universal Analytics
    function callGoogleAnalytics() {
        if (firstCall) return;
        else firstCall = true;

        gtag("js", new Date());
        gtag("config", gaProperty);

        (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
            i[r] ||
            function () {
                (i[r].q = i[r].q || []).push(arguments);
            }),
            (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
        })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
        );
        ga("create", gaProperty, "auto"); // Replace with your property ID.
        ga("send", "pageview", "/articles/devops/direnv-pour-votre-shell/");
    }

    return {
        // La fonction d'opt-out
        gaOptout: function () {
            document.cookie = `${disableStr}=true ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
            document.cookie = `hasConsent=false ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
            var div = document.getElementById("cookie-banner");
            // on considère que le site a été visité
            clickprocessed = true;
            // Ci dessous le code de la bannière affichée une fois que l'utilisateur s'est opposé au dépot
            // Vous pouvez modifier le contenu et le style
            if (div != null)
            div.innerHTML =
                '<div style="background-color:#fff;text-align:center;padding:5px;font-size:12px;border-bottom:1px solid #eeeeee;" id="cookie-message"> Vous vous êtes opposé \
                au dépôt de cookies de mesures d\'audience dans votre navigateur </div>';
            window[disableStr] = true;
            deleteAnalyticsCookies();
        },

        hideInform: function () {
            var div = document.getElementById("cookie-banner");
            div.style.display = "none";
        },

        start: function () {
            //Ce bout de code vérifie que le consentement n'a pas déjà été obtenu avant d'afficher
            // la bannière
            var consentCookie = getCookie("hasConsent");
            clickprocessed = false;
            if (!consentCookie) {
            //L'utilisateur n'a pas encore de cookie, on affiche la banniére et si il clique sur un autre élément que la banniére, on enregistre le consentement
            if (notToTrack()) {
                //L'utilisateur a activé DoNotTrack. Do not ask for consent and just opt him out
                tagAnalyticsCNIL.CookieConsent.gaOptout();
            } else {
                if (isToTrack()) {
                //DNT is set to 0, no need to ask for consent just set cookies
                consent();
                } else {
                if (window.addEventListener) {
                    // See note https://github.com/CNILlab/Cookie-consent_Google-Analytics/commit/e323b3be2c4a4d05300e35cdc11102841abdcbc9
                    // Standard browsers
                    window.addEventListener("load", showBanner, false);
                    document.addEventListener("click", consent, false);
                } else {
                    window.attachEvent("onload", showBanner);
                    document.attachEvent("onclick", consent);
                }
                }
            }
            } else {
            if (document.cookie.indexOf("hasConsent=false") > -1)
                window[disableStr] = true;
            else callGoogleAnalytics();
            }
        },
    };
  })();

  tagAnalyticsCNIL.CookieConsent.start();
</script>

        
    </head>
    <body>
        <nav class="header">
    <a class="ekite" href="https://www.ekit3.com/" target="_blank"><img alt="logo Ekite" src="/assets/images/logo-ekite.png"></a>
    <a class="link" href="/"><span class="material-icons">roofing</span><span class="a-title">Accueil</span></a>
    <!--<a class="link" href="/pageTest"><span class="material-icons">star_border</span>Page test</a>-->
    <div class="search">
        <select class="search-article">
            <option></option>
            
                <optgroup label="Front-End">
                
                    <option value="/articles/front-end/web-assembly/">Web Assembly</option>
                
                    <option value="/articles/front-end/algebraic-structure/">Les structures algébriques</option>
                
                    <option value="/articles/front-end/micro-front-end/">Micro Front End</option>
                
                    <option value="/articles/front-end/pwa-innovation-or-consolation/">PWA : Innovation ou solution de consolation ?</option>
                
            </optgroup>
            
                <optgroup label="Testing">
                
                    <option value="/articles/testing/mutation-testing/">Mutation testing</option>
                
            </optgroup>
            
                <optgroup label="Green-IT">
                
                    <option value="/articles/green-it/eco-conception/">Eco Conception</option>
                
            </optgroup>
            
                <optgroup label="Other">
                
                    <option value="/articles/other/design-pattern/">Design Pattern</option>
                
            </optgroup>
            
                <optgroup label="Devops">
                
                    <option value="/articles/devops/direnv-pour-votre-shell/">direnv pour booster votre shell</option>
                
                    <option value="/articles/devops/skaffold-et-minikube/">Exécuter une application localement sur minikube avec skaffold</option>
                
            </optgroup>
            
        </select>
    </div>
</nav>

        <main class="page-content" aria-label="Content">
            
  <div class="posts single">
    <button type="button" class="btn btn-dark btn-return" onclick="goBackHistory()">Retour</button>
    <article>
      <h2>direnv pour booster votre shell</h2>
      <div class="post-header">
          <span>Ecrit par</span>


    
    
         <a href="http://twitter.com/codekaio">Julien Wittouck</a>,
    


          <span>Publié le 02 Nov 2022</span>
      </div>
      <div class="extract">
          <span></span><p>Je suis le genre de développeur qui travaille toujours avec un terminal ouvert sur le côté, en plus de mon IDE.
Je lance souvent des commandes <code class="highlighter-rouge">mvn</code> pour m’assurer que mon projet compile et que mes tests s’exécutent correctement. C’est un vieux réflexe qui date de l’époque où les IDE n’avaient qu’un support limité de <em>Maven</em>. Lancer ces commandes hors-IDE m’aide souvent à valider que tout fonctionnera bien dans un environnement de CI par exemple.
J’ai donc parfois besoin de changer de version de <em>Java</em> en fonction du projet dans lequel je me trouve.
<em>Maven</em> utilise la variable d’environnement <code class="highlighter-rouge">JAVA_HOME</code> pour localiser l’installation de <em>Java</em> à utiliser. Donc être capable de charger des variables d’environnement différentes en fonction d’un projet peut s’avérer pratique.
Un autre usage courant consiste à venir charger des clé d’API ou des secrets d’accès cloud comme des variables <code class="highlighter-rouge">AWS_ACCESS_KEY</code> ou autres en fonction de mes différents projets.</p>

<p><code class="highlighter-rouge">direnv</code> (<a href="https://direnv.net/" target="_blank">lien</a>) est un outil écrit en go qui permet de charger des variables d’environnement dans la session courante du terminal, lorsqu’on change de répertoire en effectuant un <code class="highlighter-rouge">cd</code> .</p>

<!--END_SUMMARY-->

<h2 id="installation">Installation</h2>
<p><code class="highlighter-rouge">direnv</code> est disponible dans les dépots de nombreuses distributions Linux, l’installation sur Ubuntu se fait avec les commandes habituelles, à savoir <code class="highlighter-rouge">apt install direnv</code>.
L’installation pour d’autres distributions se fait à partir des dépôts, ou bien directement à partir de binaires pré-compilés à récupérer sur Github dans <a href="https://github.com/direnv/direnv/releases" target="_blank">les releases de direnv</a>.</p>
<h2 id="configuration">Configuration</h2>
<p>Une fois installé, il faut indiquer au shell d’appeler le binaire <code class="highlighter-rouge">direnv</code> à chaque changement de répertoire.
Le shell que j’utilise au quotidien est <code class="highlighter-rouge">zsh</code>. Pour <code class="highlighter-rouge">zsh</code>, la configuration de <code class="highlighter-rouge">direnv</code> consiste à venir modifier mon fichier <code class="highlighter-rouge">~/.zshrc</code> pour y ajouter la ligne suivante:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">eval</span> <span class="s2">"</span><span class="si">$(</span>direnv hook zsh<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>
<p>Les procédures de configuration pour les autres shells sont détaillées <a href="https://direnv.net/docs/hook.html" target="_blank">sur le site de direnv</a> et sont du même ordre que la procédure ci-dessus.</p>
<h2 id="utilisation-basique">Utilisation basique</h2>
<p>L’utilisation de <code class="highlighter-rouge">direnv</code> se fait au travers d’un fichier <code class="highlighter-rouge">.envrc</code> à positionner dans le répertoire souhaité.
Ce fichier peut contenir:</p>
<ul>
  <li>des commandes <code class="highlighter-rouge">export</code> pour déclarer des variables d’environnement</li>
  <li>des appels de fonction de la stdlib <code class="highlighter-rouge">direnv</code></li>
  <li>des appels de fonction customisés</li>
  <li>du code shell (bash)</li>
</ul>

<p>Un exemple de fichier <code class="highlighter-rouge">.envrc</code> déposé dans un répertoire <code class="highlighter-rouge">~/workspaces/demo-direnv</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/opt/jdk-17.0.1+12
<span class="nb">export </span><span class="nv">MAVEN_HOME</span><span class="o">=</span>/opt/apache-maven-3.8.4
</code></pre></div></div>
<p>Ce fichier déclare deux variables d’environnement qui me sont utiles dans un projet Java.
À l’entrée dans le répertoire contenant ce fichier, <code class="highlighter-rouge">direnv</code> va tenter de charger le fichier. Les variables d’environnement exportées par le fichier seront alors chargées dans la session shell courante.
Au premier chargement d’un fichier, ou après une modification, <code class="highlighter-rouge">direnv</code> demandera une validation explicite pour autoriser le fichier.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/workspaces <span class="o">&gt;</span> <span class="nb">cd </span>demo-direnv
direnv: error /home/jwittouck/workspaces/demo-direnv/.envrc is blocked. Run <span class="sb">`</span>direnv allow<span class="sb">`</span> to approve its content
</code></pre></div></div>
<p>J’exécute donc <code class="highlighter-rouge">direnv allow</code> pour autoriser le chargement de mon fichier <code class="highlighter-rouge">.envrc</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/workspaces/demo-direnv <span class="o">&gt;</span> direnv allow
direnv: loading ~/workspaces/demo-direnv/.envrc
direnv: <span class="nb">export</span> +JAVA_HOME +MAVEN_HOME
~/workspaces/demo-direnv <span class="o">&gt;</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">direnv</code> nous indique qu’il a chargé notre fichier, ainsi que nos deux variables d’environnement.
Nous pouvons maintenant les utiliser:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/workspaces/demo-direnv <span class="o">&gt;</span> <span class="nb">echo</span> <span class="nv">$JAVA_HOME</span>
/opt/jdk-17.0.1+12
~/workspaces/demo-direnv <span class="o">&gt;</span> <span class="nb">echo</span> <span class="nv">$MAVEN_HOME</span>
/opt/apache-maven-3.8.4
</code></pre></div></div>
<p>Si on quitte le répertoire, les variables sont déchargées:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/workspaces/demo-direnv <span class="o">&gt;</span> <span class="nb">cd</span> ..
direnv: unloading
~/workspaces <span class="o">&gt;</span> <span class="nb">echo</span> <span class="nv">$JAVA_HOME</span>
<span class="c"># rien ici !</span>
</code></pre></div></div>
<h2 id="modification-du-path">Modification du PATH</h2>
<p>Pour nous simplifier la vie, <code class="highlighter-rouge">direnv</code> propose des fonctions qui permettent de manipuler le <code class="highlighter-rouge">PATH</code> facilement. La fonction <code class="highlighter-rouge">PATH_add</code> permet d’ajouter simplement une nouvelle valeur au <code class="highlighter-rouge">PATH</code>. En voici un exemple dans mon fichier <code class="highlighter-rouge">.envrc</code> précédent:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/opt/jdk-17.0.1+12
<span class="nb">export </span><span class="nv">MAVEN_HOME</span><span class="o">=</span>/opt/apache-maven-3.8.4

PATH_add <span class="nv">$JAVA_HOME</span>/bin
PATH_add <span class="nv">$MAVEN_HOME</span>/bin
</code></pre></div></div>
<p>Avec cette nouvelle version de mon fichier, j’ai donc ajouté mes versions de <code class="highlighter-rouge">java</code> et <code class="highlighter-rouge">maven</code> au <code class="highlighter-rouge">PATH</code>.  Ces ajouts seront retirés à la sortie du répertoire:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># je rentre dans mon répertoire demo-direnv</span>
~/workspaces <span class="o">&gt;</span> <span class="nb">cd </span>demo-direnv
direnv: loading ~/workspaces/demo-direnv/.envrc
direnv: <span class="nb">export</span> +JAVA_HOME +MAVEN_HOME ~PATH

<span class="c"># le $PATH a été modifié</span>
~/workspaces/demo-direnv <span class="o">&gt;</span> java <span class="nt">--version</span>
openjdk 17.0.1 2021-10-19
OpenJDK Runtime Environment Temurin-17.0.1+12 <span class="o">(</span>build 17.0.1+12<span class="o">)</span>
OpenJDK 64-Bit Server VM Temurin-17.0.1+12 <span class="o">(</span>build 17.0.1+12, mixed mode, sharing<span class="o">)</span>

<span class="c"># je sors du répertoire</span>
~/workspaces/demo-direnv <span class="o">&gt;</span> <span class="nb">cd</span> ..
direnv: unloading

<span class="c"># le $PATH ne contient plus la commande java</span>
~/workspaces <span class="o">&gt;</span> java <span class="nt">--version</span>
zsh: <span class="nb">command </span>not found: java
</code></pre></div></div>
<p>Avec <code class="highlighter-rouge">direnv</code>, je peux donc changer de version de <code class="highlighter-rouge">java</code> dans mon <code class="highlighter-rouge">PATH</code>, simplement en changeant de répertoire.</p>
<h2 id="utilisation-avancée">Utilisation avancée</h2>
<p>Pour aller plus loin, <code class="highlighter-rouge">direnv</code> propose une librairie de fonctions qu’ils nomment <em>stdlib</em>. Ces fonctions sont listées et documentées dans la documentation de direnv <a href="https://direnv.net/man/direnv-stdlib.1.html" target="_blank">man/direnv-stdlib.1</a>.
Voici quelques unes de ces commandes que j’utilise régulièrement.</p>
<h3 id="source_up"><a href="https://direnv.net/man/direnv-stdlib.1.html#codesourceup-ltfilenamegtcode" target="_blank">source_up</a></h3>
<p>Cette commande permet d’aller chercher et exécuter le premier fichier <code class="highlighter-rouge">.envrc</code> dans l’arborescence remontante des fichiers, ce qui permet de factoriser un peu le contenu de mes fichiers <code class="highlighter-rouge">.envrc</code>.
Un exemple concret d’arborescence de fichiers:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
└── workspaces
    ├── .envrc
    ├── projet-java-11
    │   └── .envrc
    └── projet-java-17
        └── .envrc
</code></pre></div></div>
<p>Le fichier <code class="highlighter-rouge">~/workspaces/.envrc</code> contient les variables communes à mes deux projets:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">MAVEN_HOME</span><span class="o">=</span>/opt/apache-maven-3.8.4
PATH_add <span class="nv">$MAVEN_HOME</span>/bin
</code></pre></div></div>
<p>Le fichier  <code class="highlighter-rouge">~/workspaces/projet-java-11/.envrc</code> contient une configuration pour <em>Java</em> 11, ainsi que la commande <code class="highlighter-rouge">source_up</code> qui permet de charger le fichier <code class="highlighter-rouge">~/workspaces/.envrc</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source_up
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/opt/jdk-11.0.13+8
PATH_add <span class="nv">$JAVA_HOME</span>/bin
</code></pre></div></div>
<p>Le fichier  <code class="highlighter-rouge">~/workspaces/projet-java-17/.envrc</code> contient une configuration similaire pour <em>Java</em> 17:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source_up
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/opt/jdk-17.0.1+12
PATH_add <span class="nv">$JAVA_HOME</span>/bin
</code></pre></div></div>
<p>Avec cette utilisation, la variable <code class="highlighter-rouge">MAVEN_HOME</code> est disponible dans les sous-répertoires. Cette configuration permet de factoriser mes fichiers <code class="highlighter-rouge">.envrc</code> pour tous mes projets.</p>
<h3 id="dotenv"><a href="https://direnv.net/man/direnv-stdlib.1.html#codedotenv-ltdotenvpathgtcode" target="_blank">dotenv</a></h3>
<p><code class="highlighter-rouge">direnv</code> peut aussi scruter les fichiers <code class="highlighter-rouge">.env</code>, qui doivent exposer les variables d’environnement sous forme de clé/valeur. Les fichiers <code class="highlighter-rouge">.env</code> sont moins souple car aucun script ne peut y être écrit. La commande <code class="highlighter-rouge">dotenv</code> peut néanmoins aider si des <code class="highlighter-rouge">.env</code> existent déjà sur un projet.
Voici un exemple de fichier <code class="highlighter-rouge">.env</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>xxxx-xxx-xxx-xxxx
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>xxxx-xxx-xxx-xxxx
</code></pre></div></div>
<p>Et un exemple de fichier <code class="highlighter-rouge">.envrc</code> qui charge le fichier <code class="highlighter-rouge">.env</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotenv
</code></pre></div></div>
<p>Dans le cas où beaucoup de projets utilisent des <code class="highlighter-rouge">.env</code>, on peut aussi configurer <code class="highlighter-rouge">direnv</code> pour charger ces fichiers automatiquement, en plus des <code class="highlighter-rouge">.envrc</code> (qui restent chargés en priorité)
Cette configuration se fait dans <code class="highlighter-rouge">~/.config/direnv/direnv.toml</code>:</p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[global]</span>
<span class="py">load_dotenv</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>
<h3 id="whitelist"><a href="https://direnv.net/man/direnv.toml.1.html#whitelist" target="_blank">whitelist</a></h3>
<p>Par défaut, pour chaque fichier <code class="highlighter-rouge">.envrc</code>, nouveau ou modifié, <code class="highlighter-rouge">direnv</code> affichera ce message:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>direnv: error .envrc is blocked. Run `direnv allow` to approve its content
</code></pre></div></div>
<p>Il faut donc utiliser la commande <code class="highlighter-rouge">direnv allow</code> pour autoriser ces fichiers. Cela peut être assez rébarbatif quand cela arrive sur de nombreux projets.
<code class="highlighter-rouge">direnv</code> fournit une configuration permettant de whitelister les fichiers et de les autoriser automatiquement. J’y ai ajouté mon répertoire de travail. Cette configuration se fait dans <code class="highlighter-rouge">~/.config/direnv/direnv.toml</code>:</p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[whitelist]</span>
<span class="py">prefix</span> <span class="p">=</span> <span class="nn">["/home/jwittouck/workspaces"]</span>
</code></pre></div></div>
<h3 id="fonction-customisées">Fonction customisées</h3>
<p>Pour améliorer l’exemple plus haut concernant la gestion de la variable <code class="highlighter-rouge">JAVA_HOME</code>, il est aussi possible d’enrichir les fonctions disponibles de <code class="highlighter-rouge">direnv</code>.
Pour cela, il faut les ajouter au fichier <code class="highlighter-rouge">~/.config/direnv/direnvrc</code>.
Pour mon usage, j’ai créé cette fonction :</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>use_java<span class="o">(){</span>
    <span class="nb">echo</span> <span class="s2">"Using Java version </span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span><span class="si">$(</span>find /opt <span class="nt">-maxdepth</span> 1 <span class="nt">-type</span> d <span class="nt">-name</span> <span class="s2">"jdk-</span><span class="nv">$1</span><span class="s2">*"</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="s2">"Loading JAVA_HOME </span><span class="nv">$JAVA_HOME</span><span class="s2">"</span>
    PATH_add <span class="nv">$JAVA_HOME</span>/bin
<span class="o">}</span>
</code></pre></div></div>
<p>Tous mes JDK sont installés dans <code class="highlighter-rouge">/opt</code>. Cette fonction permet de trouver le JDK qui correspond au premier paramètre de la fonction et de positionner les variables <code class="highlighter-rouge">JAVA_HOME</code> et <code class="highlighter-rouge">PATH</code>.
Elle s’utilise dans un <code class="highlighter-rouge">.envrc</code> de cette manière:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use_java 17
<span class="c"># ou</span>
<span class="c"># use_java 11</span>
</code></pre></div></div>
<p>et voici ce que loggue <code class="highlighter-rouge">direnv</code> à l’entrée du répertoire :</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/workspaces <span class="o">&gt;</span> <span class="nb">cd </span>demo-direnv
direnv: loading ~/workspaces/demo-direnv/.envrc
direnv: using java 17
Using Java version 17
Loading JAVA_HOME /opt/jdk-17.0.1+12
direnv: <span class="nb">export</span> +JAVA_HOME +MAVEN_HOME ~PATH
</code></pre></div></div>
<h2 id="conclusion">Conclusion</h2>
<p><code class="highlighter-rouge">direnv</code> est un outil très pratique pour manipuler les variables d’environnement. Il s’adresse avant tout à ceux qui passent du temps dans un shell, devs ou sysadmins.
Cet article a présenté principalement les usages que j’en ai pour mes projets <em>Java</em>, mais <code class="highlighter-rouge">direnv</code> propose aussi des fonctions pour les projets <code class="highlighter-rouge">node</code>, <code class="highlighter-rouge">ruby</code>, <code class="highlighter-rouge">python</code> et d’autres.
C’est vite devenu un indispensable dans mes shells.</p>
<h3 id="liens">Liens</h3>
<ul>
  <li>la page d’accueil du projet sur <a href="https://direnv.net/" target="_blank">direnv.net</a></li>
  <li>le repository Github du projet <a href="https://github.com/direnv/direnv" target="_blank">direnv/direnv</a></li>
  <li>la documentation d’install <a href="https://direnv.net/docs/installation.html" target="_blank">docs/installation</a></li>
  <li>la documentation de la stdlib <a href="https://direnv.net/man/direnv-stdlib.1.html" target="_blank">man/direnv-stdlib</a></li>
</ul>

</span>
      </div>
    </article>
  </div>

            <footer class="footer">
    <div class="footer-content">
        <h4>Qui sommes nous :</h4>
        <p>"Nos experts vous accompagnent sur la réalisation et l’amélioration de vos systèmes d’information tout en étant en immersion dans vos équipes."</p>
    </div>
    <div class="footer-content">
        <h4>La plus-value proposée :</h4>
        <p>
            vous permettre de prendre du recul sur l’utilisation technologique afin qu’elle soit adaptée à votre contexte.
        </p>
    </div>
    <div class="footer-content">
        <h4>Nous suivre :</h4>
        <div class="social">
            <a href="https://www.linkedin.com/company/ekite/" target="_blank"><img alt="linkedin" src="/assets/images/logo-linkedin.png"></a>
            <a href="https://twitter.com/Ekite_" target="_blank"><img alt="Twitter" src="/assets/images/logo-twitter.png"></a>
            <a href="https://github.com/ekit3" target="_blank"><img alt="Github" src="/assets/images/logo-github.png"></a>
        </div>
    </div>
</footer>
 <div class="copyright">
    <span>Ekite © Copyright 2021. Tous droits réservés</span>
    <a href="/mentions">Mentions légales</a>
    <a href="https://github.com/Ekawa-fr" target="_blank">Réalisé par Ekawa</a>
</div>

        </main>
        <script src="/assets/libs/jquery-3.5.1.min.js"></script>
        <script src="/scripts/index.js"></script>
        <script src="/assets/libs/bootstrap.bundle.min.js"></script>
        <script src="/assets/libs/select2.full.min.js"></script>
        <script>
            if (window.Worker) {
                navigator.serviceWorker.register('/worker.js').then(function(registration) {
                    // console.log('ServiceWorker registration successful with scope:',  registration.scope);
                }).catch(function(error) {
                    console.warn('ServiceWorker registration failed:', error);
                });
            }
        </script>
    </body>
</html>
