
<!doctype html>
<html>
    <head>
        <meta name="theme-color" content="#000000"/>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Exécuter une application localement sur minikube avec skaffold</title>
        <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/assets/css/select2.min.css" />
        <link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Bienvenue sur le Blog d'Ekite" />
        <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="/css/main.css" />
        <link rel="icon" href="/assets/images/favicon.png" href="logo.png" />
        <link rel="manifest" href="/manifest.webmanifest">
        
            <script
  async
  src="https://www.googletagmanager.com/gtag/js?id=G-D332437KRM"
></script>
<script>

    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    var tagAnalyticsCNIL = {};

    tagAnalyticsCNIL.CookieConsent = (function () {
    var gaProperty = "G-D332437KRM";
    // Désactive le tracking si le cookie d’Opt-out existe déjà.
    var disableStr = `ga-disable-${gaProperty}`;
    var firstCall = false;
    var domaineName = "";

    //Cette fonction retourne la date d’expiration du cookie de consentement

    function getCookieExpireDate() {
        var cookieTimeout = 33696000000; // Le nombre de millisecondes que font 13 mois
        var date = new Date();
        date.setTime(date.getTime() + cookieTimeout);
        var expires = "; expires=" + date.toGMTString();
        return expires;
    }

    function getDomainName() {
        if (domaineName != "") {
            return domaineName;
        } else {
            var hostname = document.location.hostname;
            if (hostname.indexOf("www.") === 0) hostname = hostname.substring(4);
            return hostname;
        }
    }

    //Cette fonction définie le périmétre du consentement ou de l'opposition  (en fonction du domaine)
    //Par défaut nous considérons que le domaine est tout ce qu'il y'a aprés  "www"
    function getCookieDomainName() {
        var hostname = getDomainName();
        var domain = "domain=" + "." + hostname;
        return domain;
    }

    //Cette fonction vérifie si on  a déjà obtenu le consentement de la personne qui visite le site
    function checkFirstVisit() {
        var consentCookie = getCookie("hasConsent");
        if (!consentCookie) return true;
    }

    function showBanner() {
        var bodytag = document.getElementsByTagName("body")[0];
        var div = document.createElement("div");
        div.setAttribute('id','cookie-banner');
        div.style.width = window.innerWidth + "px";
        div.style.height = window.innerHeight + "px";
        div.style.position = "fixed";
        div.style.zIndex = "100000";
        div.style.backgroundColor = "#11111190"
        div.innerHTML = `
                <div style="width: 300px; 1px solid #2F343A; border-radius: 5px; background-color: #f1f1f1; repeat scroll 0% 0% white; padding :10px 10px;text-align:center; position: fixed; top:30px; left:50%; margin-top:0px; margin-left:-150px; z-index:100000; id="inform-and-consent">
                    <div>
                        <span><b>Ce site utilise Google Analytics</b></span><br/><br/>
                        En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure d'audience.
                    </div>
                    <div style="padding :20px;text-align:center;">
                    <button 
                        style="margin-right:50px;"
                        class="btn btn-light"
                        name="Refuser"
                        onclick="tagAnalyticsCNIL.CookieConsent.gaOptout();tagAnalyticsCNIL.CookieConsent.hideInform();"
                        id="optout-button">
                        Refuser
                    </button>
                    <button
                        id="accept-ga"
                        name="Valider"
                        class="btn btn-success"
                        onclick="tagAnalyticsCNIL.CookieConsent.hideInform()">
                        Accepter
                    </button>
                    </div>
                </div>
            `;
      bodytag.insertBefore(div, bodytag.firstChild);
    }

    // Fonction utile pour récupérer un cookie a partire de son nom
    function getCookie(NameOfCookie) {
        if (document.cookie.length > 0) {
            begin = document.cookie.indexOf(NameOfCookie + "=");
            if (begin != -1) {
            begin += NameOfCookie.length + 1;
            end = document.cookie.indexOf(";", begin);
            if (end == -1) end = document.cookie.length;
            return unescape(document.cookie.substring(begin, end));
            }
        }
        return null;
    }

    //Récupère la version d'Internet Explorer, si c'est un autre navigateur la fonction renvoie -1
    function getInternetExplorerVersion() {
        var rv = -1;
        if (navigator.appName == "Microsoft Internet Explorer") {
            var ua = navigator.userAgent;
            var re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) rv = parseFloat(RegExp.$1);
        } else if (navigator.appName == "Netscape") {
            var ua = navigator.userAgent;
            var re = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) rv = parseFloat(RegExp.$1);
        }
        return rv;
    }

    //Effectue une demande de confirmation de DNT pour les utilisateurs d'IE
    function askDNTConfirmation() {
        var r = confirm(
            "La signal DoNotTrack de votre navigateur est activé, confirmez vous activer la fonction DoNotTrack?"
        );
        return r;
    }

    //Vérifie la valeur de navigator.DoNotTrack pour savoir si le signal est activé et est à 1
    function notToTrack() {
        if (
            (navigator.doNotTrack &&
            (navigator.doNotTrack == "yes" || navigator.doNotTrack == "1")) ||
            (navigator.msDoNotTrack && navigator.msDoNotTrack == "1")
        ) {
            var isIE = getInternetExplorerVersion() != -1;
            if (!isIE) {
            return true;
            } else {
            return askDNTConfirmation();
            }
            return false;
        }
    }

    //Si le signal est à 0 on considére que le consentement a déjà été obtenu
    function isToTrack() {
      if (
        navigator.doNotTrack &&
        (navigator.doNotTrack == "no" || navigator.doNotTrack == 0)
      ) {
        return true;
      }
    }

    // Fonction d'effacement des cookies
    function delCookie(name) {
      var path = ";path=" + "/";

      var expiration = "Thu, 01-Jan-1970 00:00:01 GMT";
      document.cookie = `${name}=${path} ; ${getCookieDomainName()} ;expires=${expiration}`;
    }

    // Efface tous les types de cookies utilisés par Google Analytics
    function deleteAnalyticsCookies() {
      var cookieNames = ["__utma", "__utmb", "__utmc", "__utmz", "_ga", "_gat"];
      for (var i = 0; i < cookieNames.length; i++) delCookie(cookieNames[i]);
    }

    function isClickOnOptOut(evt) {
      // Si le noeud parent ou le noeud parent du parent est la banniére, on ignore le clic
      return (
        evt.target.parentNode.id == "cookie-banner" ||
        evt.target.parentNode.parentNode.id == "cookie-banner" ||
        evt.target.id == "optout-button"
      );
    }

    function consent(evt) {
      if (!isClickOnOptOut(evt)) {
        // On vérifie qu'il ne s'agit pas d'un clic sur la banniére
        if (!clickprocessed) {
         evt.preventDefault();
         closeModalAfterClickProcessed();
        }
      }
      if(evt.target.id === 'accept-ga'){
        evt.preventDefault();
          document.cookie = `hasConsent=true ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
          callGoogleAnalytics();
          closeModalAfterClickProcessed();
        }
    }

    function closeModalAfterClickProcessed(){
        clickprocessed = true;
        window.setTimeout(function () {
        evt.target.click();
        }, 1000);
        tagAnalyticsCNIL.CookieConsent.hideInform();
    }

    // Tag Google Analytics, cette version est avec le tag Universal Analytics
    function callGoogleAnalytics() {
        if (firstCall) return;
        else firstCall = true;

        gtag("js", new Date());
        gtag("config", gaProperty);

        (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
            i[r] ||
            function () {
                (i[r].q = i[r].q || []).push(arguments);
            }),
            (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
        })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
        );
        ga("create", gaProperty, "auto"); // Replace with your property ID.
        ga("send", "pageview", "/articles/devops/skaffold-et-minikube/");
    }

    return {
        // La fonction d'opt-out
        gaOptout: function () {
            document.cookie = `${disableStr}=true ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
            document.cookie = `hasConsent=false ${getCookieExpireDate()} ${getCookieDomainName()} path=/`;
            var div = document.getElementById("cookie-banner");
            // on considère que le site a été visité
            clickprocessed = true;
            // Ci dessous le code de la bannière affichée une fois que l'utilisateur s'est opposé au dépot
            // Vous pouvez modifier le contenu et le style
            if (div != null)
            div.innerHTML =
                '<div style="background-color:#fff;text-align:center;padding:5px;font-size:12px;border-bottom:1px solid #eeeeee;" id="cookie-message"> Vous vous êtes opposé \
                au dépôt de cookies de mesures d\'audience dans votre navigateur </div>';
            window[disableStr] = true;
            deleteAnalyticsCookies();
        },

        hideInform: function () {
            var div = document.getElementById("cookie-banner");
            div.style.display = "none";
        },

        start: function () {
            //Ce bout de code vérifie que le consentement n'a pas déjà été obtenu avant d'afficher
            // la bannière
            var consentCookie = getCookie("hasConsent");
            clickprocessed = false;
            if (!consentCookie) {
            //L'utilisateur n'a pas encore de cookie, on affiche la banniére et si il clique sur un autre élément que la banniére, on enregistre le consentement
            if (notToTrack()) {
                //L'utilisateur a activé DoNotTrack. Do not ask for consent and just opt him out
                tagAnalyticsCNIL.CookieConsent.gaOptout();
            } else {
                if (isToTrack()) {
                //DNT is set to 0, no need to ask for consent just set cookies
                consent();
                } else {
                if (window.addEventListener) {
                    // See note https://github.com/CNILlab/Cookie-consent_Google-Analytics/commit/e323b3be2c4a4d05300e35cdc11102841abdcbc9
                    // Standard browsers
                    window.addEventListener("load", showBanner, false);
                    document.addEventListener("click", consent, false);
                } else {
                    window.attachEvent("onload", showBanner);
                    document.attachEvent("onclick", consent);
                }
                }
            }
            } else {
            if (document.cookie.indexOf("hasConsent=false") > -1)
                window[disableStr] = true;
            else callGoogleAnalytics();
            }
        },
    };
  })();

  tagAnalyticsCNIL.CookieConsent.start();
</script>

        
    </head>
    <body>
        <nav class="header">
    <a class="ekite" href="https://www.ekit3.com/" target="_blank"><img alt="logo Ekite" src="/assets/images/logo-ekite.png"></a>
    <a class="link" href="/"><span class="material-icons">roofing</span><span class="a-title">Accueil</span></a>
    <!--<a class="link" href="/pageTest"><span class="material-icons">star_border</span>Page test</a>-->
    <div class="search">
        <select class="search-article">
            <option></option>
            
                <optgroup label="Front-End">
                
                    <option value="/articles/front-end/algebraic-structure/">Les structures algébriques</option>
                
                    <option value="/articles/front-end/micro-front-end/">Micro Front End</option>
                
                    <option value="/articles/front-end/pwa-innovation-or-consolation/">PWA : Innovation ou solution de consolation ?</option>
                
            </optgroup>
            
                <optgroup label="Testing">
                
                    <option value="/articles/testing/mutation-testing/">Mutation testing</option>
                
            </optgroup>
            
                <optgroup label="Green-IT">
                
                    <option value="/articles/green-it/eco-conception/">Eco Conception</option>
                
            </optgroup>
            
                <optgroup label="Other">
                
                    <option value="/articles/other/design-pattern/">Design Pattern</option>
                
            </optgroup>
            
                <optgroup label="Devops">
                
                    <option value="/articles/devops/skaffold-et-minikube/">Exécuter une application localement sur minikube avec skaffold</option>
                
            </optgroup>
            
        </select>
    </div>
</nav>

        <main class="page-content" aria-label="Content">
            
  <div class="posts single">
    <button type="button" class="btn btn-dark btn-return" onclick="goBackHistory()">Retour</button>
    <article>
      <h2>Exécuter une application localement sur minikube avec skaffold</h2>
      <div class="post-header">
          <span>Ecrit par</span>


    
    
         <a href="http://twitter.com/codekaio">Julien Wittouck</a>,
    


          <span>Publié le 22 Jul 2022</span>
      </div>
      <div class="extract">
          <span></span><p>Lors du développement d’une application pour Kubernetes, le développeur est souvent lié à une boucle de feedback assez longue:</p>
<ol>
  <li>Développement</li>
  <li>Contruction de l’image Docker (quelques secondes/minutes)</li>
  <li>Push de l’image sur un registry</li>
  <li>Déploiement sur Kubernetes (quelques minutes)</li>
</ol>

<p>Cette boucle est généralement implémentée par des pipelines de CI/CD. Ces pipelines augmentent encore le temps entre le développement et une application démarrée sur Kubernetes. Ce temps est relativement long lorsqu’on compare un cycle de développement local auquel un développeur peut être habitué.</p>

<p><a href="https://skaffold.dev" target="_blank"><code class="highlighter-rouge">skaffold</code></a>, développé par Google, est un outil open-source en license Apache, qui permet d’implémenter cette boucle de développement sur un environnement Kubernetes local ou distant. La promesse de <code class="highlighter-rouge">skaffold</code> est de rendre le développement sur Kubernetes simple, rapide et reproductible.</p>

<p><img src="/articles/devops/skaffold-et-minikube//skaffold.png" alt="la page d'accueil de skaffold" /></p>

<!--END_SUMMARY-->

<p><code class="highlighter-rouge">skaffold</code> implémente un <em>pipeline</em> qui se déroule en plusieurs étapes:</p>
<ol>
  <li><em>build</em> : construction des images docker avec:
    <ul>
      <li>Docker (sur base d’un <code class="highlighter-rouge">Dockerfile</code>)</li>
      <li>Buildpacks</li>
      <li>Jib</li>
    </ul>
  </li>
  <li><em>tag</em> de l’image docker en utilisant différentes stratégies :
    <ul>
      <li>l’identifiant du commit git (par défaut)</li>
      <li>une date</li>
      <li>des variables d’environnement</li>
      <li>un hash des fichiers source
      * push de l’image sur un registry
      * chargement direct de l’image dans un cluster Kubernetes</li>
    </ul>
  </li>
  <li><em>deploy</em> : déploiement de l’application sur Kubernetes (local ou distant) en utilisant:
    <ul>
      <li><code class="highlighter-rouge">kubectl</code> et des fichiers yaml</li>
      <li><code class="highlighter-rouge">kustomize</code></li>
      <li><code class="highlighter-rouge">helm</code></li>
    </ul>
  </li>
  <li><em>tail logs &amp; port forward</em> : affiche les logs de l’application et redirige un port local</li>
  <li><em>status check</em> : attend la fin du bon déploiement de application</li>
</ol>

<p><code class="highlighter-rouge">skaffold</code> a besoin d’un code à déployer, ainsi qu’un accès à un cluster Kubernetes. L’accès au cluster se configure de la même manière que pour <code class="highlighter-rouge">kubectl</code>, à travers un fichier <code class="highlighter-rouge">~/.kube/config</code>. Pour la suite de cet article, j’utilise un cluster <code class="highlighter-rouge">minikube</code> que j’installe sur mon poste pour l’occasion.</p>

<h2 id="déployer-un-cluster-minikube-localement">Déployer un cluster minikube localement</h2>
<p>La première étape consiste à déployer un cluster <code class="highlighter-rouge">minikube</code> sur mon poste de développement.
Pour ce faire, le plus pratique est de suivre les étapes d’installation de l’outil détaillées <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank">dans leur documentation d’installation</a>.</p>

<p><img src="/articles/devops/skaffold-et-minikube//minikube-install.png" alt="installation de minikube" /></p>

<p>Voici les commandes que j’ai exécuté pour installer <code class="highlighter-rouge">minikube</code> sur mon poste Linux :</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-LO</span> https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
<span class="nb">sudo install </span>minikube-linux-amd64 /usr/local/bin/minikube
</code></pre></div></div>
<p><code class="highlighter-rouge">docker</code> étant déjà installé sur mon poste, je peux tout de suite démarrer un cluster Kubernetes local avec la commande <code class="highlighter-rouge">minikube start</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>minikube start
😄  minikube v1.24.0 on Debian bookworm/sid
🎉  minikube 1.26.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.26.0
💡  To disable this notice, run: <span class="s1">'minikube config set WantUpdateNotification false'</span>

✨  Using the docker driver based on existing profile
👍  Starting control plane node minikube <span class="k">in </span>cluster minikube
🚜  Pulling base image ...
🔄  Restarting existing docker container <span class="k">for</span> <span class="s2">"minikube"</span> ...

🧯  Docker is nearly out of disk space, which may cause deployments to fail! <span class="o">(</span>92% of capacity<span class="o">)</span>
💡  Suggestion: 

    Try one or more of the following to free up space on the device:
    
    1. Run <span class="s2">"docker system prune"</span> to remove unused Docker data <span class="o">(</span>optionally with <span class="s2">"-a"</span><span class="o">)</span>
    2. Increase the storage allocated to Docker <span class="k">for </span>Desktop by clicking on:
    Docker icon <span class="o">&gt;</span> Preferences <span class="o">&gt;</span> Resources <span class="o">&gt;</span> Disk Image Size
    3. Run <span class="s2">"minikube ssh -- docker system prune"</span> <span class="k">if </span>using the Docker container runtime
🍿  Related issue: https://github.com/kubernetes/minikube/issues/9024

🐳  Preparing Kubernetes v1.22.3 on Docker 20.10.8 ...
🔎  Verifying Kubernetes components...
    ▪ Using image gcr.io/k8s-minikube/storage-provisioner:v5
    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
    ▪ Using image k8s.gcr.io/ingress-nginx/controller:v1.0.4
    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
🔎  Verifying ingress addon...
🌟  Enabled addons: storage-provisioner, default-storageclass, ingress
🏄  Done! kubectl is now configured to use <span class="s2">"minikube"</span> cluster and <span class="s2">"default"</span> namespace by default
</code></pre></div></div>
<p>Par défaut, <code class="highlighter-rouge">minikube</code> va générer un fichier de configuration pour <code class="highlighter-rouge">kubectl</code> dans <code class="highlighter-rouge">~/.kube/config</code>. La commande <code class="highlighter-rouge">kubectl</code> sera donc immédiatement utilisable:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get nodes
NAME       STATUS   ROLES                  AGE    VERSION
minikube   Ready    control-plane,master   1d     v1.22.3
</code></pre></div></div>
<p>Si la commande <code class="highlighter-rouge">kubectl</code> n’est pas installée, <code class="highlighter-rouge">minikube</code> l’intègre et elle est utilisable de cette manière:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>minikube kubectl get nodes
NAME       STATUS   ROLES                  AGE    VERSION
minikube   Ready    control-plane,master   1d     v1.22.3
</code></pre></div></div>
<p>Pour ma part, j’ai installé <code class="highlighter-rouge">kubectl</code> avec l’outil de packaging de mon système en suivant <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-using-native-package-management" target="_blank">cette procédure</a>.
Une fois que <code class="highlighter-rouge">minikube</code> et <code class="highlighter-rouge">kubectl</code> sont installés, démarrés et configurés, je peux passer à l’installation de <code class="highlighter-rouge">skaffold</code>.</p>
<h2 id="installation-de-skaffold">Installation de skaffold</h2>
<p>L’installation de <code class="highlighter-rouge">skaffold</code> est similaire à celle de <code class="highlighter-rouge">minikube</code> et <code class="highlighter-rouge">kubectl</code>.
J’ai suivi la procédure sur <a href="https://skaffold.dev/docs/install/" target="_blank">dans leur documentation</a> et installé la version Linux avec ces commandes:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-Lo</span> skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64 <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">sudo install </span>skaffold /usr/local/bin/
</code></pre></div></div>
<p><code class="highlighter-rouge">skaffold</code> est maintenant disponible sur mon poste:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>skaffold version
v1.39.1
</code></pre></div></div>
<h2 id="configuration-dun-projet">Configuration d’un projet</h2>
<p><code class="highlighter-rouge">skaffold</code> se configure avec un fichier <code class="highlighter-rouge">skaffold.yml</code> à positionner à la racine de votre projet.
J’ai pris pour exemple un projet Micronaut avec lequel je suis en train d’expérimenter:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── micronaut-cli.yml
├── mvnw
├── mvnw.bat
├── pom.xml
├── README.md
└── src
    └── main
        ├── java
        │   └── com
        │       └── example
        │           ├── Application.java
        │           └── pokemons
        │               ├── PokemonController.java
        │               ├── Pokemon.java
        │               ├── PokemonRepository.java
        │               └── PokemonService.java
        └── resources
            ├── application.yml
            ├── bootstrap.yml
            └── logback.xml
</code></pre></div></div>
<p>La configuration initiale du projet se fait en utilisant la commande <code class="highlighter-rouge">skaffold init</code> . Cette commande propose différentes options (<a href="https://skaffold.dev/docs/pipeline-stages/init/" target="_blank">documentation</a>) en interactif pour créer son fichier de configuration. Cette étape est plus simple qu’écrire le fichier à la main.
Comme je n’ai pas encore écrit de fichiers manifest Kubernetes pour mon application, <code class="highlighter-rouge">skaffold</code> a une option pour les générer: <code class="highlighter-rouge">--generate-manifests</code>.</p>

<p>La première étape consiste à configurer la phase de <em>build</em> de l’application, à savoir la construction de l’image docker. Plusieurs options seront proposées, en fonction de ce qui est déjà disponible dans le code : <code class="highlighter-rouge">Dockerfile</code>, configuration de <code class="highlighter-rouge">jib</code>, ou manifests Kubernetes.
Mon projet Micronaut a déjà une configuration pour <code class="highlighter-rouge">jib</code> dans son <code class="highlighter-rouge">pom.xml</code>:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;build&gt;</span>
  <span class="nt">&lt;plugins&gt;</span>
    <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.google.cloud.tools<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jib-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">skaffold init</code> me propose alors de paramétrer ma phase de <em>build</em> avec Buildpacks ou Jib:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>skaffold init <span class="nt">--generate-manifests</span>
? Which builders would you like to create Kubernetes resources <span class="k">for</span>?  <span class="o">[</span>Use arrows to move, space to <span class="k">select</span>, &lt;right&gt; to all, &lt;left&gt; to none, <span class="nb">type </span>to filter]
<span class="o">&gt;</span> <span class="o">[</span> <span class="o">]</span>  Buildpacks <span class="o">(</span>pom.xml<span class="o">)</span>
  <span class="o">[</span> <span class="o">]</span>  Jib Maven Plugin <span class="o">(</span>com.example:demo-app-pokemon-micronaut, pom.xml<span class="o">)</span>
</code></pre></div></div>
<p>Je choisis l’option <em>Jib</em> étant donné que ce plugin est déjà configuré pour mon application.</p>

<p>L’étape suivante propose de configurer un port à forwarder pour mon image Docker, je saisis le port 8080 qui est le port par défaut de mon application:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>? Select port to forward <span class="k">for </span>pom-xml-image <span class="o">(</span>leave blank <span class="k">for </span>none<span class="o">)</span>: 8080
</code></pre></div></div>
<p><code class="highlighter-rouge">skaffold</code> me propose ensuite un manifest Kubernetes et me demande si je souhaite générer les fichiers:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>? Do you want to write this configuration, along with the generated k8s manifests, to skaffold.yaml? Yes
Generated manifest deployment.yaml was written
Configuration skaffold.yaml was written
You can now run <span class="o">[</span>skaffold build] to build the artifacts
or <span class="o">[</span>skaffold run] to build and deploy
or <span class="o">[</span>skaffold dev] to enter development mode, with auto-redeploy
</code></pre></div></div>
<p>À noter que si des fichiers de déploiement Kubernetes sont déjà présents dans l’application, <code class="highlighter-rouge">skaffold</code> les détecte et les ajoute à sa configuration automatiquement.
Le fichier <code class="highlighter-rouge">deployment.yaml</code> généré pour Kubernetes est simple:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
</code></pre></div></div>
<p>ainsi que le fichier <code class="highlighter-rouge">skaffold.yaml</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">skaffold/v2beta29</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo-app-pokemon-micronaut</span>
<span class="na">build</span><span class="pi">:</span>
  <span class="na">artifacts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
    <span class="na">jib</span><span class="pi">:</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">com.example:demo-app-pokemon-micronaut</span>
<span class="na">deploy</span><span class="pi">:</span>
  <span class="na">kubectl</span><span class="pi">:</span>
    <span class="na">manifests</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">deployment.yaml</span>
<span class="na">portForward</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">resourceType</span><span class="pi">:</span> <span class="s">service</span>
  <span class="na">resourceName</span><span class="pi">:</span> <span class="s">pom-xml-image</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>
<p>Le fichier généré contient de la configuration pour 3 étapes du pipeline de <code class="highlighter-rouge">skaffold</code>.</p>

<p>La phase de <em>build</em> est bien configurée pour construire une image Docker en utilisant <em>Jib</em>, l’image produite sera nommée <code class="highlighter-rouge">pom-xml-image</code>. Ce nom par défaut pourra être changé en modifiant ce fichier de configuration.</p>

<p>La phase de <em>deploy</em> est configurée pour déployer des manifests Kubernetes, ici le fichier <code class="highlighter-rouge">deployment.yaml</code> qui a été généré par la commande <code class="highlighter-rouge">skaffold init</code>. Ces fichiers manifest référencent l’image <code class="highlighter-rouge">pom-xml-image</code> dans la partie <em>Deployment</em> du manifest.
On voit donc ici comment on peut adapter cette configuration pour inclure d’autres fichiers, comme une <em>ConfigMap</em>.</p>

<p>J’ai pris le parti de déplacer les fichiers de manifest Kubernetes générés dans le répertoire <code class="highlighter-rouge">src/main/Kubernetes</code> de mon application et de renommer l’image générée.
Voici la structure de mon application après ces opérations:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── micronaut-cli.yml
├── mvnw
├── mvnw.bat
├── pom.xml
├── README.md
├── skaffold.yaml
└── src
    └── main
        ├── java
        │   └── com
        │       └── example
        │           ├── Application.java
        │           └── pokemons
        │               ├── PokemonController.java
        │               ├── Pokemon.java
        │               ├── PokemonRepository.java
        │               └── PokemonService.java
        ├── kubernetes
        │   ├── configMap.yaml
        │   ├── deployment.yaml
        │   └── service.yaml
        └── resources
            ├── application.yml
            ├── bootstrap.yml
            └── logback.xml
</code></pre></div></div>
<p>Ainsi que le fichier <code class="highlighter-rouge">skaffold.yaml</code>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">skaffold/v2beta29</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo-skaffold</span>
<span class="na">build</span><span class="pi">:</span>
  <span class="na">artifacts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">demo-skaffold</span>
    <span class="na">jib</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">deploy</span><span class="pi">:</span>
  <span class="na">kubectl</span><span class="pi">:</span>
    <span class="na">manifests</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">src/main/kubernetes/*.yaml</span>
<span class="na">portForward</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">resourceType</span><span class="pi">:</span> <span class="s">service</span>
  <span class="na">resourceName</span><span class="pi">:</span> <span class="s">demo-skaffold</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>
<h2 id="démarrage-de-mon-projet">Démarrage de mon projet</h2>
<p>Une fois les fichiers générés, la commande <code class="highlighter-rouge">skaffold dev</code> va:</p>
<ul>
  <li>construire l’image docker en utilisant le builder <em>Jib</em> configuré</li>
  <li>déposer cette image directement dans l’environnement du <code class="highlighter-rouge">minikube</code></li>
  <li>déployer les fichiers de configuration Kubernetes</li>
  <li>ouvrir un port-forward sur mon port d’écoute 8080</li>
  <li>afficher les logs de mon application dans mon shell</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>skaffold dev   
Listing files to watch...
 - demo-skaffold
Generating tags...
 - demo-skaffold -&gt; demo-skaffold:latest
Some taggers failed. Rerun with <span class="nt">-vdebug</span> <span class="k">for </span>errors.
Checking cache...
 - demo-skaffold: Found Locally
Tags used <span class="k">in </span>deployment:
 - demo-skaffold -&gt; demo-skaffold:275bf648a141313e52f422d73ad69379be4f4d7c3e9e50fe3c16289da8391c33
Starting deploy...
 - configmap/demo-skaffold created
 - deployment.apps/demo-skaffold created
 - service/demo-skaffold created
Waiting <span class="k">for </span>deployments to stabilize...
 - deployment/demo-skaffold is ready.
Deployments stabilized <span class="k">in </span>2.047 seconds
Port forwarding service/demo-skaffold <span class="k">in </span>namespace default, remote port 8080 -&gt; http://127.0.0.1:8080
Press Ctrl+C to <span class="nb">exit
</span>Watching <span class="k">for </span>changes...
<span class="o">[</span>backend]  __  __ _                                  _   
<span class="o">[</span>backend] |  <span class="se">\/</span>  <span class="o">(</span>_<span class="o">)</span> ___ _ __ ___  _ __   __ _ _   _| |_ 
<span class="o">[</span>backend] | |<span class="se">\/</span>| | |/ __| <span class="s1">'__/ _ \| '</span>_ <span class="se">\ </span>/ _<span class="sb">`</span> | | | | __|
<span class="o">[</span>backend] | |  | | | <span class="o">(</span>__| | | <span class="o">(</span>_<span class="o">)</span> | | | | <span class="o">(</span>_| | |_| | |_ 
<span class="o">[</span>backend] |_|  |_|_|<span class="se">\_</span>__|_|  <span class="se">\_</span>__/|_| |_|<span class="se">\_</span>_,_|<span class="se">\_</span>_,_|<span class="se">\_</span>_|
<span class="o">[</span>backend]   Micronaut <span class="o">(</span>v3.5.1<span class="o">)</span>
<span class="o">[</span>backend] 
<span class="o">[</span>backend] 14:15:41.202 <span class="o">[</span>main] INFO  i.m.context.env.DefaultEnvironment - Established active environments: <span class="o">[</span>k8s, cloud]
<span class="o">[</span>backend] 14:15:41.557 <span class="o">[</span>main] INFO  io.micronaut.runtime.Micronaut - Startup completed <span class="k">in </span>803ms. Server Running: http://demo-skaffold-5bfb47c8fc-cvld4:8080
</code></pre></div></div>
<p><img src="/articles/devops/skaffold-et-minikube//localhost.png" alt="" /></p>

<p>En quelques minutes, mon application est démarré sur mon cluster <code class="highlighter-rouge">minikube</code> local.
Je peux voir avec une commande <code class="highlighter-rouge">kubectl get all</code> que mes manifests ont bien été déployés et que mon application tourne:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get all
NAME                                 READY   STATUS    RESTARTS   AGE
pod/demo-skaffold-5bfb47c8fc-cvld4   1/1     Running   0          19m

NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
service/demo-skaffold   ClusterIP   None         &lt;none&gt;        8080/TCP   19m
service/kubernetes      ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP    1d

NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/demo-skaffold   1/1     1            1           19m

NAME                                       DESIRED   CURRENT   READY   AGE
replicaset.apps/demo-skaffold-5bfb47c8fc   1         1         1       19m

</code></pre></div></div>
<p><code class="highlighter-rouge">skaffold</code> est aussi capable de faire du <em>hot-reload</em> sans configuration supplémentaire pour les applications buildées avec <em>jib</em>.
Il suffit de:</p>
<ul>
  <li>modifier le code</li>
  <li>attendre quelques secondes que le code soit re-compilé et l’application est re-démarrée</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Watching <span class="k">for </span>changes...
Generating tags...
 - pom-xml-image -&gt; pom-xml-image:latest
Some taggers failed. Rerun with <span class="nt">-vdebug</span> <span class="k">for </span>errors.
Checking cache...
 - pom-xml-image: Not found. Building
Starting build...
Found <span class="o">[</span>minikube] context, using <span class="nb">local </span>docker daemon.
Building <span class="o">[</span>pom-xml-image]...
Target platforms: <span class="o">[</span>linux/amd64]

...

Build <span class="o">[</span>pom-xml-image] succeeded
Tags used <span class="k">in </span>deployment:
 - pom-xml-image -&gt; pom-xml-image:c6d646c3c9ba7ac130cfe23c31b2391584b4bddfce984b2cc1f1f2c711c9d509
Starting deploy...
Waiting <span class="k">for </span>deployments to stabilize...
 - deployment/pom-xml-image is ready.
Deployments stabilized <span class="k">in </span>1.038 second
Port forwarding service/pom-xml-image <span class="k">in </span>namespace default, remote port 8080 -&gt; http://127.0.0.1:8080
Watching <span class="k">for </span>changes...
</code></pre></div></div>
<p>C’est particulièrement pratique pour tester une application localement!
Si je veux arrêter de développer, j’utilise la combinaison de touches <em>CTRL+C</em>, qui va stopper l’application et faire le ménage sur le cluster Kubernetes:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>^C
Cleaning up...
 - configmap <span class="s2">"demo-skaffold"</span> deleted
 - deployment.apps <span class="s2">"demo-skaffold"</span> deleted
 - service <span class="s2">"demo-skaffold"</span> deleted
</code></pre></div></div>
<h2 id="conclusion">Conclusion</h2>
<p><code class="highlighter-rouge">skaffold</code> permet de rendre accessible au développeur le déploiement sur un cluster Kubernetes, local ou distant. Cet article a présenté son usage sur un cluster local <code class="highlighter-rouge">minikube</code>, mais <code class="highlighter-rouge">skaffold</code> fonctionne de manière indifférenciée sur un cluster distant. Il permet aussi de réutiliser des fichiers de configuration Kubernetes, Kustomize ou Helm existants, ce qui est très pratique si l’application dispose déjà de ce type de fichiers.</p>

<p>Le port forward est très bien intégré et pratique à l’usage (pas besoin de taper une commande <code class="highlighter-rouge">kubectl</code> supplémentaire).</p>

<p>La <a href="https://skaffold.dev/docs/" target="_blank">documentation de <code class="highlighter-rouge">skaffold</code></a> est très complète et indique tous les paramètres que chaque phase de son pipeline accepte et fourni aussi des liens vers des tutoriaux.</p>

<p>Enfin, <code class="highlighter-rouge">skaffold</code> est au coeur des plugins <em>Cloud Code</em> de Google, pour IntelliJ IDEA et VSCode pour l’exécution et le déploiement des application sur Kubernetes.</p>

<p>De nombreux <a href="https://github.com/GoogleContainerTools/skaffold/tree/main/examples" target="_blank">exemples</a> sont disponibles sur le repository Github de <code class="highlighter-rouge">skaffold</code>, il y en aura surement un qui correspondra à votre type de projet si vous voulez expérimenter.</p>

<h3 id="liens">Liens</h3>

<ul>
  <li>le repository Github de <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank">GoogleContainerTools/skaffold</a></li>
  <li>le site web <a href="https://skaffold.dev/" target="_blank">skaffold.dev</a></li>
  <li>la <a href="https://skaffold.dev/docs/" target="_blank">documentation</a></li>
  <li>les <a href="https://github.com/GoogleContainerTools/skaffold/tree/main/examples" target="_blank">exemples de code sur Github</a></li>
</ul>
</span>
      </div>
    </article>
  </div>

            <footer class="footer">
    <div class="footer-content">
        <h4>Qui sommes nous :</h4>
        <p>"Nos experts vous accompagnent sur la réalisation et l’amélioration de vos systèmes d’information tout en étant en immersion dans vos équipes."</p>
    </div>
    <div class="footer-content">
        <h4>La plus-value proposée :</h4>
        <p>
            vous permettre de prendre du recul sur l’utilisation technologique afin qu’elle soit adaptée à votre contexte.
        </p>
    </div>
    <div class="footer-content">
        <h4>Nous suivre :</h4>
        <div class="social">
            <a href="https://www.linkedin.com/company/ekite/" target="_blank"><img alt="linkedin" src="/assets/images/logo-linkedin.png"></a>
            <a href="https://twitter.com/Ekite_" target="_blank"><img alt="Twitter" src="/assets/images/logo-twitter.png"></a>
            <a href="https://github.com/ekit3" target="_blank"><img alt="Github" src="/assets/images/logo-github.png"></a>
        </div>
    </div>
</footer>
 <div class="copyright">
    <span>Ekite © Copyright 2021. Tous droits réservés</span>
    <a href="/mentions">Mentions légales</a>
    <a href="https://github.com/Ekawa-fr" target="_blank">Réalisé par Ekawa</a>
</div>

        </main>
        <script src="/assets/libs/jquery-3.5.1.min.js"></script>
        <script src="/scripts/index.js"></script>
        <script src="/assets/libs/bootstrap.bundle.min.js"></script>
        <script src="/assets/libs/select2.full.min.js"></script>
        <script>
            if (window.Worker) {
                navigator.serviceWorker.register('/worker.js').then(function(registration) {
                    // console.log('ServiceWorker registration successful with scope:',  registration.scope);
                }).catch(function(error) {
                    console.warn('ServiceWorker registration failed:', error);
                });
            }
        </script>
    </body>
</html>
